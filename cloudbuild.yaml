steps:
  # Build docker image for target sub-package
  - name: gcr.io/cloud-builders/docker
    id: Build Image
    env:
      - 'NEXT_PUBLIC_ENV=${BRANCH_NAME}'
      - 'NEXT_PUBLIC_IS_PREVIEW_MODE=${_IS_PREVIEW_MODE}'
    entrypoint: 'bash'
    args:
      - '-c'
      - |
        # Copy root files and workspace packages for monorepo build
        cp yarn.lock Dockerfile .dockerignore prettier.config.js packages/$_TARGET_PACKAGE/
        # Copy root configs separately to avoid overwriting package's own configs
        cp package.json packages/$_TARGET_PACKAGE/root-package.json
        cp .eslintrc.js packages/$_TARGET_PACKAGE/root-eslintrc.js
        cp -r packages/draft-renderer packages/$_TARGET_PACKAGE/
        cd packages/$_TARGET_PACKAGE
        printenv > .env.local
        docker build -t gcr.io/$PROJECT_ID/$_IMAGE_NAME:${BRANCH_NAME}_${SHORT_SHA} .

  # Push docker image
  - name: gcr.io/cloud-builders/docker
    id: Push Image
    args:
      - push
      - 'gcr.io/$PROJECT_ID/$_IMAGE_NAME:${BRANCH_NAME}_${SHORT_SHA}'

  # Deploy container image to Cloud Run with Secrets
  - name: gcr.io/cloud-builders/gcloud
    id: Deploy Image
    env:
      - 'BRANCH_NAME=${BRANCH_NAME}'
    entrypoint: 'bash'
    args:
      - '-c'
      - |
        # Determine secret suffix based on _ENVIRONMENT variable (if set) or branch
        if [ -n "$_ENVIRONMENT" ]; then
          case "$_ENVIRONMENT" in
            prod|production) SUFFIX="_PROD" ;;
            staging)         SUFFIX="_STAGING" ;;
            *)               SUFFIX="_DEV" ;;
          esac
        else
          case "$$BRANCH_NAME" in
            main|master|prod) SUFFIX="_PROD" ;;
            staging)          SUFFIX="_STAGING" ;;
            *)                SUFFIX="_DEV" ;;
          esac
        fi

        echo "Deploying with secrets suffix: $$SUFFIX"

        # Build secrets string - only add secrets that exist
        SECRETS=""

        add_secret() {
          local env_var="$$1"
          local secret_name="$$2"
          # Check if secret exists AND has at least one version
          if gcloud secrets versions list "$$secret_name" --project=$PROJECT_ID --limit=1 --format="value(name)" 2>/dev/null | grep -q .; then
            if [ -z "$$SECRETS" ]; then
              SECRETS="$$env_var=$$secret_name:latest"
            else
              SECRETS="$$SECRETS,$$env_var=$$secret_name:latest"
            fi
            echo "  ✓ Adding secret: $$secret_name"
          else
            echo "  ⚠ Skipping missing/empty secret: $$secret_name"
          fi
        }

        add_secret "FIREBASE_ADMIN_PROJECT_ID" "FIREBASE_ADMIN_PROJECT_ID$$SUFFIX"
        add_secret "FIREBASE_ADMIN_CLIENT_EMAIL" "FIREBASE_ADMIN_CLIENT_EMAIL$$SUFFIX"
        add_secret "FIREBASE_ADMIN_PRIVATE_KEY" "FIREBASE_ADMIN_PRIVATE_KEY$$SUFFIX"
        add_secret "TURNSTILE_SECRET_KEY" "TURNSTILE_SECRET_KEY$$SUFFIX"
        add_secret "MAILCHIMP_API_KEY" "MAILCHIMP_API_KEY$$SUFFIX"
        add_secret "MAILCHIMP_LIST_ID_DAILY" "MAILCHIMP_LIST_ID_DAILY$$SUFFIX"
        add_secret "MAILCHIMP_LIST_ID_WEEKLY" "MAILCHIMP_LIST_ID_WEEKLY$$SUFFIX"

        echo "Secrets config: $$SECRETS"

        # Read cloud run service names from substitution variable
        IFS=',' read -r -a cloud_runs <<< "$_CLOUD_RUN_SERVICE_NAMES"

        for cr in "$${cloud_runs[@]}"
        do
          echo "Deploying to Cloud Run service: $$cr"

          if [ -n "$$SECRETS" ]; then
            gcloud run deploy "$$cr" \
              --image gcr.io/$PROJECT_ID/$_IMAGE_NAME:${BRANCH_NAME}_${SHORT_SHA} \
              --region asia-east1 \
              --set-secrets="$$SECRETS"
          else
            echo "  ⚠ No secrets found, deploying and clearing existing secrets"
            gcloud run deploy "$$cr" \
              --image gcr.io/$PROJECT_ID/$_IMAGE_NAME:${BRANCH_NAME}_${SHORT_SHA} \
              --region asia-east1 \
              --clear-secrets
          fi

        done

options:
  logging: CLOUD_LOGGING_ONLY

timeout: 1800s

images: ['gcr.io/$PROJECT_ID/$_IMAGE_NAME:${BRANCH_NAME}_${SHORT_SHA}']

substitutions:
  _TARGET_PACKAGE: ''
  _IMAGE_NAME: ''
  _CLOUD_RUN_SERVICE_NAMES: ''
  _ENVIRONMENT: ''  # Optional: 'dev', 'staging', 'prod' - overrides branch-based detection
  _IS_PREVIEW_MODE: 'false'  # Preview mode: 'true' to enable preview deployment
